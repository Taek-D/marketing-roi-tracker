<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketingROI Tracker - Interactive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            color: #202124;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
            color: white;
            padding: 28px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.3px; }
        .header-meta {
            display: flex;
            gap: 24px;
            margin-top: 6px;
            font-size: 13px;
            opacity: 0.85;
        }

        /* Layout */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .kpi-card.highlight {
            background: #e8f0fe;
            border: 1px solid #c6dafc;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .kpi-card.highlight .kpi-value { color: #1a73e8; }
        .kpi-label {
            font-size: 11px;
            color: #5f6368;
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        /* Chart Sections */
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .chart-card.full {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-title .badge {
            font-size: 10px;
            background: #e8f0fe;
            color: #1a73e8;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .chart-container {
            position: relative;
            width: 100%;
        }
        .chart-container.tall { height: 380px; }
        .chart-container.medium { height: 320px; }
        .chart-container.short { height: 280px; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            overflow: hidden;
            font-size: 14px;
        }
        .data-table th {
            background: #f8f9fa;
            color: #5f6368;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #e8eaed;
        }
        .data-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f1f3f4;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
        .tag {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .tag-best { background: #e6f4ea; color: #137333; }
        .tag-good { background: #e8f0fe; color: #1967d2; }
        .tag-warn { background: #fce8e6; color: #c5221f; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            font-size: 12px;
            color: #80868b;
        }
        .footer a { color: #1a73e8; text-decoration: none; }

        /* Filter Bar */
        .filter-bar {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }
        .channel-toggles { display: flex; gap: 8px; }
        .ch-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #e8eaed;
            background: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }
        .ch-toggle .dot {
            width: 10px; height: 10px; border-radius: 50%;
        }
        .ch-toggle.active { border-color: currentColor; background: var(--ch-light); }
        .ch-toggle:not(.active) { opacity: 0.45; }
        .date-range { display: flex; align-items: center; gap: 8px; }
        .date-range input[type="date"] {
            padding: 5px 10px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            color: #202124;
        }
        .date-range span { color: #80868b; font-size: 13px; }
        .filter-reset {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid #dadce0;
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: #5f6368;
            transition: all 0.15s;
            margin-left: auto;
        }
        .filter-reset:hover { background: #f8f9fa; border-color: #1a73e8; color: #1a73e8; }
        .filter-summary {
            width: 100%;
            font-size: 11px;
            color: #80868b;
            margin-top: 2px;
        }

        /* Data badge */
        .data-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fef7e0;
            border: 1px solid #fdd663;
            border-radius: 6px;
            padding: 8px 14px;
            font-size: 12px;
            color: #795548;
            margin-bottom: 20px;
        }
        .data-badge strong { color: #5d4037; }

        /* Responsive */
        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-row { grid-template-columns: 1fr; }
            .container { padding: 16px; }
        }
        @media (max-width: 500px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>마케팅 ROI 대시보드</h1>
        <div class="header-meta">
            <span id="headerPeriod">기간: 2024-10-01 ~ 2024-12-29 (90일)</span>
            <span id="headerChannels">채널: Google Ads, Facebook Ads, Naver Ads</span>
            <span id="headerData">데이터: 810행 (3채널 x 3캠페인 x 90일)</span>
        </div>
    </div>

    <div class="container">
        <!-- Data Badge -->
        <div class="data-badge">
            <strong>데이터 소스:</strong> generate_data.py (12개 마케팅 패턴, seed=42) | Supabase PostgreSQL
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <span class="filter-label">채널</span>
            <div class="channel-toggles">
                <button class="ch-toggle active" data-ch="Google" style="color:#EA4335;--ch-light:rgba(234,67,53,0.1)">
                    <span class="dot" style="background:#EA4335"></span>Google Ads
                </button>
                <button class="ch-toggle active" data-ch="Facebook" style="color:#1877f2;--ch-light:rgba(24,119,242,0.1)">
                    <span class="dot" style="background:#1877f2"></span>Facebook Ads
                </button>
                <button class="ch-toggle active" data-ch="Naver" style="color:#03c75a;--ch-light:rgba(3,199,90,0.1)">
                    <span class="dot" style="background:#03c75a"></span>Naver Ads
                </button>
            </div>
            <span class="filter-label" style="margin-left:8px">기간</span>
            <div class="date-range">
                <input type="date" id="startDate" value="2024-10-01" min="2024-10-01" max="2024-12-29">
                <span>~</span>
                <input type="date" id="endDate" value="2024-12-29" min="2024-10-01" max="2024-12-29">
            </div>
            <button class="filter-reset" onclick="resetFilters()">초기화</button>
            <div class="filter-summary" id="filterSummary">전체 3개 채널 | 90일 | 810개 데이터</div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="kpiSpend">$164,170</div>
                <div class="kpi-label">총 광고비</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiRevenue">$437,128</div>
                <div class="kpi-label">총 매출</div>
            </div>
            <div class="kpi-card highlight">
                <div class="kpi-value" id="kpiRoas">2.66</div>
                <div class="kpi-label">평균 ROAS</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiConversions">31,481</div>
                <div class="kpi-label">총 전환수</div>
            </div>
        </div>

        <!-- Row 1: ROAS Bar + Revenue Pie -->
        <div class="chart-row">
            <div class="chart-card">
                <div class="chart-title">채널별 ROAS 비교 <span class="badge">인터랙티브</span></div>
                <div class="chart-container medium">
                    <canvas id="roasBarChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">채널별 매출 비중 <span class="badge">인터랙티브</span></div>
                <div class="chart-container medium">
                    <canvas id="revenuePieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: Daily ROAS Line (Full Width) -->
        <div class="chart-row">
            <div class="chart-card full">
                <div class="chart-title">일별 ROAS 추이 + 7일 이동평균 <span class="badge">90일</span></div>
                <div class="chart-container tall">
                    <canvas id="roasLineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: Campaign Matrix + Funnel Table -->
        <div class="chart-row">
            <div class="chart-card">
                <div class="chart-title">캠페인 성과 (비용 vs 매출) <span class="badge">Bubble</span></div>
                <div class="chart-container medium">
                    <canvas id="campaignBubbleChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">채널별 퍼널 지표</div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>채널</th>
                            <th>CTR (%)</th>
                            <th>CVR (%)</th>
                            <th>CPA ($)</th>
                            <th>ROAS</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody id="funnelBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>마케팅 ROI Tracker v0.7.0 | Google Apps Script + Supabase PostgreSQL</p>
        <p>Chart.js 기반 | <a href="https://github.com/Taek-D/marketing-roi-tracker" target="_blank">GitHub Repository</a></p>
    </div>

    <script>
    // ===== COLORS =====
    const COLORS = {
        Google: { bg: '#EA4335', border: '#C5221F', light: 'rgba(234,67,53,0.15)', label: 'Google Ads' },
        Facebook: { bg: '#1877f2', border: '#1664d9', light: 'rgba(24,119,242,0.15)', label: 'Facebook Ads' },
        Naver: { bg: '#03c75a', border: '#02a84c', light: 'rgba(3,199,90,0.15)', label: 'Naver Ads' }
    };
    const ALL_CHANNELS = ['Google', 'Facebook', 'Naver'];

    // ===== RAW DATA =====
    const rawDaily = [{"d":"2024-10-01","c":"Facebook","co":448.04,"im":42133,"cl":1580,"cv":52,"rv":827.96},{"d":"2024-10-01","c":"Google","co":724.94,"im":52839,"cl":2493,"cv":82,"rv":1806.59},{"d":"2024-10-01","c":"Naver","co":481.84,"im":43053,"cl":2524,"cv":128,"rv":1356.98},{"d":"2024-10-02","c":"Facebook","co":542.8,"im":47114,"cl":1879,"cv":66,"rv":986.35},{"d":"2024-10-02","c":"Google","co":634.22,"im":62360,"cl":3275,"cv":128,"rv":1974.1},{"d":"2024-10-02","c":"Naver","co":554.83,"im":43926,"cl":2376,"cv":123,"rv":1688.44},{"d":"2024-10-03","c":"Facebook","co":491.32,"im":48237,"cl":2023,"cv":64,"rv":1170.58},{"d":"2024-10-03","c":"Google","co":575.57,"im":52830,"cl":2815,"cv":71,"rv":1458.72},{"d":"2024-10-03","c":"Naver","co":568.5,"im":38160,"cl":1911,"cv":89,"rv":1947.14},{"d":"2024-10-04","c":"Facebook","co":486.44,"im":36445,"cl":1784,"cv":59,"rv":955.01},{"d":"2024-10-04","c":"Google","co":614.25,"im":59624,"cl":3335,"cv":171,"rv":1747.02},{"d":"2024-10-04","c":"Naver","co":616.56,"im":53852,"cl":3070,"cv":129,"rv":1906.42},{"d":"2024-10-05","c":"Facebook","co":719.14,"im":53823,"cl":2608,"cv":87,"rv":1507.94},{"d":"2024-10-05","c":"Google","co":445.7,"im":37231,"cl":1851,"cv":72,"rv":1316.37},{"d":"2024-10-05","c":"Naver","co":362.19,"im":42866,"cl":2135,"cv":88,"rv":1213.87},{"d":"2024-10-06","c":"Facebook","co":854.48,"im":64177,"cl":2395,"cv":78,"rv":1561.75},{"d":"2024-10-06","c":"Google","co":609.96,"im":40814,"cl":1911,"cv":69,"rv":1495.33},{"d":"2024-10-06","c":"Naver","co":438.02,"im":31797,"cl":1596,"cv":68,"rv":1344.05},{"d":"2024-10-07","c":"Facebook","co":560.13,"im":48459,"cl":1818,"cv":51,"rv":1160.21},{"d":"2024-10-07","c":"Google","co":623.24,"im":49254,"cl":2787,"cv":129,"rv":1841.09},{"d":"2024-10-07","c":"Naver","co":590.18,"im":66582,"cl":3129,"cv":149,"rv":2001.87},{"d":"2024-10-08","c":"Facebook","co":502.79,"im":41675,"cl":1753,"cv":64,"rv":922.41},{"d":"2024-10-08","c":"Google","co":805.76,"im":69826,"cl":3170,"cv":108,"rv":2049.31},{"d":"2024-10-08","c":"Naver","co":518.68,"im":42931,"cl":2163,"cv":114,"rv":1829.22},{"d":"2024-10-09","c":"Facebook","co":461.44,"im":43615,"cl":1773,"cv":45,"rv":902.5},{"d":"2024-10-09","c":"Google","co":695.44,"im":72957,"cl":4012,"cv":144,"rv":1829.75},{"d":"2024-10-09","c":"Naver","co":588.3,"im":64432,"cl":3181,"cv":151,"rv":1690.13},{"d":"2024-10-10","c":"Facebook","co":484.54,"im":42487,"cl":1673,"cv":56,"rv":1040.28},{"d":"2024-10-10","c":"Google","co":543.27,"im":48408,"cl":2275,"cv":68,"rv":1314.26},{"d":"2024-10-10","c":"Naver","co":540.55,"im":51206,"cl":2691,"cv":100,"rv":1485.99},{"d":"2024-10-11","c":"Facebook","co":484.57,"im":37393,"cl":1360,"cv":53,"rv":815.06},{"d":"2024-10-11","c":"Google","co":621.49,"im":52389,"cl":2437,"cv":115,"rv":1930.68},{"d":"2024-10-11","c":"Naver","co":629.8,"im":56017,"cl":3237,"cv":155,"rv":1967.32},{"d":"2024-10-12","c":"Facebook","co":789.56,"im":60297,"cl":2634,"cv":90,"rv":1458.47},{"d":"2024-10-12","c":"Google","co":438.83,"im":47508,"cl":2193,"cv":85,"rv":974.13},{"d":"2024-10-12","c":"Naver","co":396.71,"im":28928,"cl":1603,"cv":85,"rv":1494.4},{"d":"2024-10-13","c":"Facebook","co":704.85,"im":62225,"cl":2346,"cv":67,"rv":1314.66},{"d":"2024-10-13","c":"Google","co":535.36,"im":44908,"cl":2203,"cv":84,"rv":1460.98},{"d":"2024-10-13","c":"Naver","co":243.54,"im":23901,"cl":1469,"cv":65,"rv":905.83},{"d":"2024-10-14","c":"Facebook","co":468.17,"im":37147,"cl":1609,"cv":42,"rv":1088.35},{"d":"2024-10-14","c":"Google","co":548.12,"im":57020,"cl":2669,"cv":89,"rv":1533.08},{"d":"2024-10-14","c":"Naver","co":661.96,"im":58348,"cl":2750,"cv":120,"rv":1950.42},{"d":"2024-10-15","c":"Facebook","co":447.44,"im":43526,"cl":1891,"cv":60,"rv":1010.87},{"d":"2024-10-15","c":"Google","co":534.15,"im":61995,"cl":3548,"cv":171,"rv":1538.34},{"d":"2024-10-15","c":"Naver","co":709.47,"im":69588,"cl":3502,"cv":161,"rv":1720.27},{"d":"2024-10-16","c":"Facebook","co":455.77,"im":38724,"cl":1567,"cv":47,"rv":968.14},{"d":"2024-10-16","c":"Google","co":627.44,"im":51077,"cl":2892,"cv":121,"rv":1513.35},{"d":"2024-10-16","c":"Naver","co":473.64,"im":42114,"cl":1919,"cv":85,"rv":1199.19},{"d":"2024-10-17","c":"Facebook","co":496.36,"im":45562,"cl":2029,"cv":60,"rv":861.96},{"d":"2024-10-17","c":"Google","co":662.2,"im":57800,"cl":2640,"cv":109,"rv":1688.81},{"d":"2024-10-17","c":"Naver","co":540.23,"im":49165,"cl":2894,"cv":165,"rv":1938.03},{"d":"2024-10-18","c":"Facebook","co":462.61,"im":34898,"cl":1485,"cv":52,"rv":970.18},{"d":"2024-10-18","c":"Google","co":673.28,"im":45378,"cl":2220,"cv":104,"rv":1849.08},{"d":"2024-10-18","c":"Naver","co":513.91,"im":53756,"cl":3138,"cv":172,"rv":1853.52},{"d":"2024-10-19","c":"Facebook","co":741.74,"im":84041,"cl":3112,"cv":92,"rv":1275.1},{"d":"2024-10-19","c":"Google","co":397.32,"im":35184,"cl":1773,"cv":62,"rv":1070.26},{"d":"2024-10-19","c":"Naver","co":321.51,"im":33849,"cl":1480,"cv":75,"rv":1083.16},{"d":"2024-10-20","c":"Facebook","co":853.35,"im":81219,"cl":3493,"cv":125,"rv":1582.34},{"d":"2024-10-20","c":"Google","co":440.24,"im":46152,"cl":2269,"cv":107,"rv":1357.77},{"d":"2024-10-20","c":"Naver","co":372.22,"im":24355,"cl":1447,"cv":83,"rv":965.34},{"d":"2024-10-21","c":"Facebook","co":508.68,"im":38575,"cl":1474,"cv":49,"rv":966.2},{"d":"2024-10-21","c":"Google","co":735.52,"im":77502,"cl":3578,"cv":111,"rv":1966.65},{"d":"2024-10-21","c":"Naver","co":699.48,"im":70262,"cl":4191,"cv":168,"rv":2125.03},{"d":"2024-10-22","c":"Facebook","co":632.37,"im":52884,"cl":2237,"cv":78,"rv":1425.29},{"d":"2024-10-22","c":"Google","co":724.69,"im":70514,"cl":2687,"cv":122,"rv":1492.13},{"d":"2024-10-22","c":"Naver","co":684.65,"im":51226,"cl":2885,"cv":130,"rv":2288.94},{"d":"2024-10-23","c":"Facebook","co":529.67,"im":45713,"cl":2031,"cv":68,"rv":1040.69},{"d":"2024-10-23","c":"Google","co":713.24,"im":77993,"cl":3497,"cv":118,"rv":1924.9},{"d":"2024-10-23","c":"Naver","co":493.9,"im":55520,"cl":3188,"cv":179,"rv":1386.32},{"d":"2024-10-24","c":"Facebook","co":509.75,"im":46341,"cl":2408,"cv":63,"rv":1078.53},{"d":"2024-10-24","c":"Google","co":645.66,"im":52427,"cl":3066,"cv":123,"rv":1779.69},{"d":"2024-10-24","c":"Naver","co":652.97,"im":72500,"cl":3399,"cv":184,"rv":1891.31},{"d":"2024-10-25","c":"Facebook","co":628.91,"im":61308,"cl":2116,"cv":68,"rv":1335.51},{"d":"2024-10-25","c":"Google","co":736.77,"im":86552,"cl":3814,"cv":155,"rv":1693.67},{"d":"2024-10-25","c":"Naver","co":589.24,"im":41710,"cl":2103,"cv":101,"rv":1727.78},{"d":"2024-10-26","c":"Facebook","co":499.94,"im":51429,"cl":1810,"cv":56,"rv":1107.65},{"d":"2024-10-26","c":"Google","co":324.85,"im":28945,"cl":1324,"cv":59,"rv":758.25},{"d":"2024-10-26","c":"Naver","co":273.47,"im":28294,"cl":1449,"cv":75,"rv":749.59},{"d":"2024-10-27","c":"Facebook","co":596.8,"im":48191,"cl":2173,"cv":60,"rv":978.19},{"d":"2024-10-27","c":"Google","co":341.37,"im":32730,"cl":1509,"cv":59,"rv":887.73},{"d":"2024-10-27","c":"Naver","co":355.07,"im":32086,"cl":1594,"cv":72,"rv":1062.23},{"d":"2024-10-28","c":"Facebook","co":419.39,"im":34034,"cl":1053,"cv":40,"rv":823.94},{"d":"2024-10-28","c":"Google","co":444.34,"im":34148,"cl":1673,"cv":58,"rv":1245.48},{"d":"2024-10-28","c":"Naver","co":467.46,"im":35980,"cl":1661,"cv":77,"rv":1669.47},{"d":"2024-10-29","c":"Facebook","co":405.47,"im":38309,"cl":1387,"cv":37,"rv":830.36},{"d":"2024-10-29","c":"Google","co":514.49,"im":45734,"cl":2716,"cv":129,"rv":1352.48},{"d":"2024-10-29","c":"Naver","co":393.84,"im":31489,"cl":1655,"cv":86,"rv":1442.88},{"d":"2024-10-30","c":"Facebook","co":363.09,"im":37587,"cl":1699,"cv":53,"rv":723.26},{"d":"2024-10-30","c":"Google","co":518.46,"im":57982,"cl":2907,"cv":124,"rv":1494.41},{"d":"2024-10-30","c":"Naver","co":524.12,"im":36673,"cl":1632,"cv":58,"rv":1780.52},{"d":"2024-10-31","c":"Facebook","co":373.6,"im":31240,"cl":1216,"cv":38,"rv":698.1},{"d":"2024-10-31","c":"Google","co":477.51,"im":41829,"cl":2145,"cv":104,"rv":1261.55},{"d":"2024-10-31","c":"Naver","co":415.86,"im":47214,"cl":2984,"cv":167,"rv":1239.53},{"d":"2024-11-01","c":"Facebook","co":584.49,"im":51444,"cl":2470,"cv":87,"rv":1215.91},{"d":"2024-11-01","c":"Google","co":698.22,"im":72035,"cl":2897,"cv":102,"rv":1936.97},{"d":"2024-11-01","c":"Naver","co":768.45,"im":70776,"cl":3383,"cv":137,"rv":2436.96},{"d":"2024-11-02","c":"Facebook","co":886.68,"im":63103,"cl":2211,"cv":75,"rv":1725.6},{"d":"2024-11-02","c":"Google","co":492.75,"im":41305,"cl":2109,"cv":101,"rv":1353.7},{"d":"2024-11-02","c":"Naver","co":428.36,"im":36821,"cl":2148,"cv":99,"rv":1208.38},{"d":"2024-11-03","c":"Facebook","co":784.84,"im":75482,"cl":3265,"cv":108,"rv":1599.27},{"d":"2024-11-03","c":"Google","co":547.95,"im":47427,"cl":2580,"cv":108,"rv":1340.88},{"d":"2024-11-03","c":"Naver","co":390.64,"im":48066,"cl":2704,"cv":126,"rv":1288.52},{"d":"2024-11-04","c":"Facebook","co":530.27,"im":51089,"cl":1886,"cv":46,"rv":980.48},{"d":"2024-11-04","c":"Google","co":581.88,"im":47628,"cl":2427,"cv":98,"rv":1675.24},{"d":"2024-11-04","c":"Naver","co":671.41,"im":54444,"cl":2824,"cv":146,"rv":1905.83},{"d":"2024-11-05","c":"Facebook","co":642.62,"im":62866,"cl":2540,"cv":85,"rv":1287.29},{"d":"2024-11-05","c":"Google","co":600.6,"im":56599,"cl":2580,"cv":79,"rv":1472.19},{"d":"2024-11-05","c":"Naver","co":694.84,"im":54771,"cl":2823,"cv":152,"rv":2304.41},{"d":"2024-11-06","c":"Facebook","co":583.27,"im":60154,"cl":2689,"cv":80,"rv":1109.02},{"d":"2024-11-06","c":"Google","co":774.06,"im":64762,"cl":2715,"cv":80,"rv":1704.43},{"d":"2024-11-06","c":"Naver","co":619.69,"im":53066,"cl":2516,"cv":108,"rv":2020.38},{"d":"2024-11-07","c":"Facebook","co":593.65,"im":57504,"cl":2239,"cv":81,"rv":1185.2},{"d":"2024-11-07","c":"Google","co":653.52,"im":58081,"cl":2492,"cv":77,"rv":1750.32},{"d":"2024-11-07","c":"Naver","co":529.64,"im":37648,"cl":2009,"cv":71,"rv":2146.09},{"d":"2024-11-08","c":"Facebook","co":529.43,"im":48066,"cl":1969,"cv":73,"rv":1111.44},{"d":"2024-11-08","c":"Google","co":832.85,"im":79656,"cl":4254,"cv":173,"rv":2112.17},{"d":"2024-11-08","c":"Naver","co":631.9,"im":61564,"cl":2893,"cv":139,"rv":2059.9},{"d":"2024-11-09","c":"Facebook","co":828.91,"im":58677,"cl":2038,"cv":72,"rv":1497.29},{"d":"2024-11-09","c":"Google","co":532.04,"im":48765,"cl":2108,"cv":90,"rv":1328.27},{"d":"2024-11-09","c":"Naver","co":331.27,"im":27345,"cl":1517,"cv":71,"rv":1028.76},{"d":"2024-11-10","c":"Facebook","co":838.92,"im":68883,"cl":2434,"cv":75,"rv":1659.66},{"d":"2024-11-10","c":"Google","co":442.49,"im":39973,"cl":1988,"cv":72,"rv":993.53},{"d":"2024-11-10","c":"Naver","co":375.97,"im":33802,"cl":1789,"cv":68,"rv":1309.82},{"d":"2024-11-11","c":"Facebook","co":610.91,"im":60892,"cl":2606,"cv":85,"rv":1115.05},{"d":"2024-11-11","c":"Google","co":650.57,"im":55828,"cl":2912,"cv":108,"rv":1578.05},{"d":"2024-11-11","c":"Naver","co":785.31,"im":67118,"cl":3454,"cv":232,"rv":2239.97},{"d":"2024-11-12","c":"Facebook","co":616.91,"im":58223,"cl":2293,"cv":70,"rv":1315.51},{"d":"2024-11-12","c":"Google","co":741.45,"im":88532,"cl":3721,"cv":139,"rv":1831.46},{"d":"2024-11-12","c":"Naver","co":635.92,"im":52032,"cl":3286,"cv":203,"rv":2128.13},{"d":"2024-11-13","c":"Facebook","co":560.49,"im":59188,"cl":2452,"cv":100,"rv":1129.57},{"d":"2024-11-13","c":"Google","co":660.66,"im":62611,"cl":2952,"cv":111,"rv":1797.36},{"d":"2024-11-13","c":"Naver","co":697.31,"im":64168,"cl":3015,"cv":136,"rv":2403.92},{"d":"2024-11-14","c":"Facebook","co":542.07,"im":44532,"cl":1815,"cv":74,"rv":1149.53},{"d":"2024-11-14","c":"Google","co":522.36,"im":52760,"cl":2392,"cv":76,"rv":1358.73},{"d":"2024-11-14","c":"Naver","co":734.44,"im":67725,"cl":3065,"cv":139,"rv":2425.95},{"d":"2024-11-15","c":"Facebook","co":623.33,"im":59034,"cl":2531,"cv":120,"rv":1167.43},{"d":"2024-11-15","c":"Google","co":783.97,"im":73605,"cl":3913,"cv":140,"rv":2139.13},{"d":"2024-11-15","c":"Naver","co":571.29,"im":68113,"cl":2901,"cv":131,"rv":2155.42},{"d":"2024-11-16","c":"Facebook","co":704.25,"im":59478,"cl":2198,"cv":80,"rv":1300.49},{"d":"2024-11-16","c":"Google","co":498.88,"im":52417,"cl":3325,"cv":145,"rv":1292.83},{"d":"2024-11-16","c":"Naver","co":419.34,"im":41859,"cl":2457,"cv":103,"rv":1321.0},{"d":"2024-11-17","c":"Facebook","co":812.02,"im":67965,"cl":2983,"cv":119,"rv":1753.56},{"d":"2024-11-17","c":"Google","co":505.47,"im":47750,"cl":2719,"cv":98,"rv":1419.21},{"d":"2024-11-17","c":"Naver","co":398.52,"im":34985,"cl":2198,"cv":156,"rv":1661.13},{"d":"2024-11-18","c":"Facebook","co":771.42,"im":71017,"cl":2921,"cv":94,"rv":1259.51},{"d":"2024-11-18","c":"Google","co":694.23,"im":74038,"cl":4104,"cv":137,"rv":2069.14},{"d":"2024-11-18","c":"Naver","co":727.92,"im":57564,"cl":2779,"cv":158,"rv":2023.56},{"d":"2024-11-19","c":"Facebook","co":631.94,"im":47963,"cl":1821,"cv":47,"rv":1320.18},{"d":"2024-11-19","c":"Google","co":969.54,"im":99170,"cl":4757,"cv":163,"rv":2211.89},{"d":"2024-11-19","c":"Naver","co":787.95,"im":83141,"cl":4393,"cv":228,"rv":2274.87},{"d":"2024-11-20","c":"Facebook","co":565.09,"im":46376,"cl":2103,"cv":87,"rv":1161.06},{"d":"2024-11-20","c":"Google","co":650.47,"im":68672,"cl":3336,"cv":143,"rv":1719.97},{"d":"2024-11-20","c":"Naver","co":703.96,"im":69696,"cl":3937,"cv":210,"rv":2321.77},{"d":"2024-11-21","c":"Facebook","co":619.95,"im":50504,"cl":1820,"cv":70,"rv":1220.5},{"d":"2024-11-21","c":"Google","co":588.7,"im":54449,"cl":2911,"cv":112,"rv":1781.76},{"d":"2024-11-21","c":"Naver","co":675.36,"im":64461,"cl":2911,"cv":138,"rv":2308.96},{"d":"2024-11-22","c":"Facebook","co":536.0,"im":53030,"cl":2141,"cv":97,"rv":1238.63},{"d":"2024-11-22","c":"Google","co":802.56,"im":94423,"cl":5077,"cv":226,"rv":2352.02},{"d":"2024-11-22","c":"Naver","co":792.93,"im":59543,"cl":2782,"cv":165,"rv":2381.45},{"d":"2024-11-23","c":"Facebook","co":864.15,"im":74312,"cl":2680,"cv":89,"rv":1632.53},{"d":"2024-11-23","c":"Google","co":480.95,"im":47502,"cl":2067,"cv":106,"rv":1456.14},{"d":"2024-11-23","c":"Naver","co":412.33,"im":42740,"cl":2082,"cv":104,"rv":1271.44},{"d":"2024-11-24","c":"Facebook","co":901.5,"im":59325,"cl":1581,"cv":59,"rv":1728.8},{"d":"2024-11-24","c":"Google","co":543.51,"im":46643,"cl":1955,"cv":92,"rv":1320.42},{"d":"2024-11-24","c":"Naver","co":548.14,"im":44439,"cl":1817,"cv":86,"rv":1480.39},{"d":"2024-11-25","c":"Facebook","co":550.91,"im":43392,"cl":1512,"cv":44,"rv":1073.65},{"d":"2024-11-25","c":"Google","co":636.67,"im":55997,"cl":2893,"cv":143,"rv":1655.14},{"d":"2024-11-25","c":"Naver","co":636.15,"im":42131,"cl":2449,"cv":126,"rv":1866.19},{"d":"2024-11-26","c":"Facebook","co":382.17,"im":35073,"cl":1467,"cv":44,"rv":855.12},{"d":"2024-11-26","c":"Google","co":472.05,"im":42969,"cl":2396,"cv":91,"rv":1231.55},{"d":"2024-11-26","c":"Naver","co":453.47,"im":45231,"cl":2131,"cv":103,"rv":1381.59},{"d":"2024-11-27","c":"Facebook","co":381.22,"im":32431,"cl":1398,"cv":55,"rv":773.65},{"d":"2024-11-27","c":"Google","co":483.28,"im":51269,"cl":2588,"cv":134,"rv":1348.5},{"d":"2024-11-27","c":"Naver","co":586.09,"im":64785,"cl":3197,"cv":164,"rv":1844.82},{"d":"2024-11-28","c":"Facebook","co":627.05,"im":50551,"cl":1827,"cv":61,"rv":2570.35},{"d":"2024-11-28","c":"Google","co":798.46,"im":59554,"cl":2248,"cv":107,"rv":4497.18},{"d":"2024-11-28","c":"Naver","co":820.99,"im":64107,"cl":3624,"cv":165,"rv":4063.59},{"d":"2024-11-29","c":"Facebook","co":682.31,"im":68830,"cl":2600,"cv":95,"rv":2912.46},{"d":"2024-11-29","c":"Google","co":665.32,"im":64831,"cl":3711,"cv":160,"rv":4014.25},{"d":"2024-11-29","c":"Naver","co":655.43,"im":56777,"cl":3303,"cv":183,"rv":4257.9},{"d":"2024-11-30","c":"Facebook","co":752.53,"im":63255,"cl":2006,"cv":72,"rv":2726.28},{"d":"2024-11-30","c":"Google","co":507.85,"im":58675,"cl":3046,"cv":111,"rv":2490.16},{"d":"2024-11-30","c":"Naver","co":406.24,"im":28696,"cl":1761,"cv":97,"rv":2030.64},{"d":"2024-12-01","c":"Facebook","co":1254.06,"im":106847,"cl":4031,"cv":210,"rv":4810.88},{"d":"2024-12-01","c":"Google","co":757.4,"im":57029,"cl":2494,"cv":103,"rv":4008.05},{"d":"2024-12-01","c":"Naver","co":622.98,"im":56682,"cl":3139,"cv":191,"rv":3940.23},{"d":"2024-12-02","c":"Facebook","co":686.18,"im":48702,"cl":2374,"cv":104,"rv":1329.04},{"d":"2024-12-02","c":"Google","co":764.77,"im":66074,"cl":3081,"cv":192,"rv":2221.23},{"d":"2024-12-02","c":"Naver","co":738.69,"im":64230,"cl":3937,"cv":229,"rv":2003.7},{"d":"2024-12-03","c":"Facebook","co":454.52,"im":50542,"cl":1504,"cv":78,"rv":918.89},{"d":"2024-12-03","c":"Google","co":846.72,"im":95771,"cl":4408,"cv":215,"rv":2038.64},{"d":"2024-12-03","c":"Naver","co":675.23,"im":58999,"cl":2956,"cv":198,"rv":2005.68},{"d":"2024-12-04","c":"Facebook","co":735.34,"im":68151,"cl":2730,"cv":118,"rv":1722.97},{"d":"2024-12-04","c":"Google","co":721.95,"im":69099,"cl":4724,"cv":405,"rv":2057.22},{"d":"2024-12-04","c":"Naver","co":711.89,"im":78945,"cl":3320,"cv":197,"rv":2056.77},{"d":"2024-12-05","c":"Facebook","co":631.69,"im":54574,"cl":2384,"cv":119,"rv":1275.03},{"d":"2024-12-05","c":"Google","co":694.7,"im":54672,"cl":2411,"cv":157,"rv":1750.79},{"d":"2024-12-05","c":"Naver","co":694.07,"im":44585,"cl":2400,"cv":166,"rv":2265.8},{"d":"2024-12-06","c":"Facebook","co":625.03,"im":60245,"cl":2520,"cv":110,"rv":1016.87},{"d":"2024-12-06","c":"Google","co":623.3,"im":64175,"cl":3199,"cv":165,"rv":1666.19},{"d":"2024-12-06","c":"Naver","co":651.11,"im":52110,"cl":2829,"cv":156,"rv":2045.94},{"d":"2024-12-07","c":"Facebook","co":939.35,"im":89628,"cl":3352,"cv":140,"rv":1687.02},{"d":"2024-12-07","c":"Google","co":492.24,"im":40838,"cl":2510,"cv":146,"rv":1143.78},{"d":"2024-12-07","c":"Naver","co":454.99,"im":37077,"cl":1651,"cv":113,"rv":1496.03},{"d":"2024-12-08","c":"Facebook","co":832.47,"im":82717,"cl":3239,"cv":163,"rv":1576.67},{"d":"2024-12-08","c":"Google","co":493.54,"im":39730,"cl":1538,"cv":66,"rv":1510.93},{"d":"2024-12-08","c":"Naver","co":399.15,"im":48223,"cl":2578,"cv":142,"rv":1264.55},{"d":"2024-12-09","c":"Facebook","co":651.82,"im":58220,"cl":2149,"cv":101,"rv":1121.29},{"d":"2024-12-09","c":"Google","co":720.18,"im":72063,"cl":4080,"cv":257,"rv":1967.11},{"d":"2024-12-09","c":"Naver","co":632.64,"im":67001,"cl":3687,"cv":268,"rv":2082.09},{"d":"2024-12-10","c":"Facebook","co":636.56,"im":51117,"cl":1622,"cv":72,"rv":1427.01},{"d":"2024-12-10","c":"Google","co":766.73,"im":65443,"cl":2597,"cv":99,"rv":1909.69},{"d":"2024-12-10","c":"Naver","co":722.32,"im":51645,"cl":2605,"cv":178,"rv":2406.9},{"d":"2024-12-11","c":"Facebook","co":653.0,"im":64056,"cl":2392,"cv":89,"rv":1217.7},{"d":"2024-12-11","c":"Google","co":1029.97,"im":98200,"cl":5357,"cv":319,"rv":2251.56},{"d":"2024-12-11","c":"Naver","co":803.06,"im":81675,"cl":4845,"cv":280,"rv":2428.37},{"d":"2024-12-12","c":"Facebook","co":561.35,"im":37676,"cl":1642,"cv":71,"rv":1172.32},{"d":"2024-12-12","c":"Google","co":746.93,"im":78140,"cl":2957,"cv":124,"rv":1816.85},{"d":"2024-12-12","c":"Naver","co":625.97,"im":50372,"cl":2606,"cv":145,"rv":1681.46},{"d":"2024-12-13","c":"Facebook","co":547.47,"im":38719,"cl":1490,"cv":64,"rv":1094.72},{"d":"2024-12-13","c":"Google","co":837.17,"im":83838,"cl":3717,"cv":175,"rv":2044.76},{"d":"2024-12-13","c":"Naver","co":615.6,"im":43915,"cl":2212,"cv":139,"rv":2104.31},{"d":"2024-12-14","c":"Facebook","co":867.45,"im":68610,"cl":2555,"cv":104,"rv":1458.06},{"d":"2024-12-14","c":"Google","co":488.27,"im":35813,"cl":1651,"cv":111,"rv":1286.06},{"d":"2024-12-14","c":"Naver","co":439.76,"im":34839,"cl":1968,"cv":152,"rv":1547.49},{"d":"2024-12-15","c":"Facebook","co":997.68,"im":92452,"cl":3072,"cv":147,"rv":1643.77},{"d":"2024-12-15","c":"Google","co":407.14,"im":28185,"cl":1583,"cv":94,"rv":1183.67},{"d":"2024-12-15","c":"Naver","co":389.08,"im":44737,"cl":2503,"cv":139,"rv":1214.02},{"d":"2024-12-16","c":"Facebook","co":779.07,"im":60870,"cl":2355,"cv":103,"rv":1416.43},{"d":"2024-12-16","c":"Google","co":749.43,"im":68205,"cl":3008,"cv":176,"rv":2196.2},{"d":"2024-12-16","c":"Naver","co":864.96,"im":84722,"cl":4753,"cv":284,"rv":2847.79},{"d":"2024-12-17","c":"Facebook","co":479.66,"im":41794,"cl":2033,"cv":93,"rv":870.54},{"d":"2024-12-17","c":"Google","co":609.31,"im":63557,"cl":3561,"cv":175,"rv":1744.14},{"d":"2024-12-17","c":"Naver","co":622.2,"im":63278,"cl":2987,"cv":141,"rv":1813.55},{"d":"2024-12-18","c":"Facebook","co":737.83,"im":77687,"cl":2918,"cv":22,"rv":374.06},{"d":"2024-12-18","c":"Google","co":932.75,"im":101535,"cl":4476,"cv":224,"rv":2836.34},{"d":"2024-12-18","c":"Naver","co":686.78,"im":63695,"cl":2737,"cv":190,"rv":2049.84},{"d":"2024-12-19","c":"Facebook","co":689.76,"im":62120,"cl":2218,"cv":16,"rv":302.33},{"d":"2024-12-19","c":"Google","co":821.81,"im":64151,"cl":3370,"cv":216,"rv":1823.88},{"d":"2024-12-19","c":"Naver","co":774.33,"im":92420,"cl":4773,"cv":273,"rv":2301.61},{"d":"2024-12-20","c":"Facebook","co":609.6,"im":52797,"cl":1803,"cv":65,"rv":1192.85},{"d":"2024-12-20","c":"Google","co":834.4,"im":65371,"cl":2870,"cv":134,"rv":1808.57},{"d":"2024-12-20","c":"Naver","co":705.1,"im":50184,"cl":2205,"cv":177,"rv":1732.41},{"d":"2024-12-21","c":"Facebook","co":845.92,"im":82550,"cl":3005,"cv":127,"rv":1766.57},{"d":"2024-12-21","c":"Google","co":452.82,"im":44637,"cl":2063,"cv":126,"rv":1103.82},{"d":"2024-12-21","c":"Naver","co":383.6,"im":38558,"cl":1620,"cv":86,"rv":921.86},{"d":"2024-12-22","c":"Facebook","co":766.58,"im":63803,"cl":2458,"cv":104,"rv":1525.71},{"d":"2024-12-22","c":"Google","co":508.2,"im":38861,"cl":1935,"cv":100,"rv":1181.04},{"d":"2024-12-22","c":"Naver","co":450.83,"im":41357,"cl":2186,"cv":168,"rv":1419.87},{"d":"2024-12-23","c":"Facebook","co":609.23,"im":44615,"cl":1718,"cv":64,"rv":1224.38},{"d":"2024-12-23","c":"Google","co":711.93,"im":50979,"cl":2669,"cv":144,"rv":1949.77},{"d":"2024-12-23","c":"Naver","co":631.71,"im":52485,"cl":2806,"cv":151,"rv":1695.0},{"d":"2024-12-24","c":"Facebook","co":668.36,"im":55521,"cl":2346,"cv":104,"rv":1295.92},{"d":"2024-12-24","c":"Google","co":854.04,"im":80490,"cl":4528,"cv":271,"rv":2360.3},{"d":"2024-12-24","c":"Naver","co":793.23,"im":65824,"cl":3968,"cv":235,"rv":2506.91},{"d":"2024-12-25","c":"Facebook","co":747.78,"im":68710,"cl":2632,"cv":101,"rv":1516.28},{"d":"2024-12-25","c":"Google","co":888.86,"im":84435,"cl":3606,"cv":192,"rv":1985.74},{"d":"2024-12-25","c":"Naver","co":711.07,"im":64475,"cl":3284,"cv":206,"rv":2429.17},{"d":"2024-12-26","c":"Facebook","co":426.39,"im":39980,"cl":1664,"cv":70,"rv":821.14},{"d":"2024-12-26","c":"Google","co":580.13,"im":62653,"cl":2963,"cv":174,"rv":1565.92},{"d":"2024-12-26","c":"Naver","co":379.5,"im":29438,"cl":1594,"cv":106,"rv":1249.4},{"d":"2024-12-27","c":"Facebook","co":495.77,"im":36462,"cl":1293,"cv":52,"rv":1066.29},{"d":"2024-12-27","c":"Google","co":538.01,"im":36530,"cl":1909,"cv":94,"rv":1528.74},{"d":"2024-12-27","c":"Naver","co":490.1,"im":39179,"cl":1898,"cv":119,"rv":1768.61},{"d":"2024-12-28","c":"Facebook","co":650.75,"im":54103,"cl":2399,"cv":111,"rv":1064.58},{"d":"2024-12-28","c":"Google","co":346.73,"im":34678,"cl":1759,"cv":99,"rv":894.38},{"d":"2024-12-28","c":"Naver","co":323.99,"im":32872,"cl":1836,"cv":102,"rv":1028.43},{"d":"2024-12-29","c":"Facebook","co":812.09,"im":73620,"cl":2743,"cv":99,"rv":1201.81},{"d":"2024-12-29","c":"Google","co":434.69,"im":37086,"cl":1938,"cv":91,"rv":1253.2},{"d":"2024-12-29","c":"Naver","co":361.32,"im":31672,"cl":1558,"cv":102,"rv":1162.52}];
    const rawCampaign = [{"ch":"Facebook Ads","camp":"FB_Interest","co":19734.53,"im":1737667,"cl":62016,"cv":1746,"rv":36015.76},{"ch":"Facebook Ads","camp":"FB_Lookalike","co":25148.79,"im":2205299,"cl":77288,"cv":2787,"rv":50052.2},{"ch":"Facebook Ads","camp":"FB_Retargeting","co":11971.95,"im":1025369,"cl":56249,"cv":2552,"rv":29206.03},{"ch":"Google Ads","camp":"Google_Brand","co":15573.73,"im":1426370,"cl":110974,"cv":6990,"rv":53977.43},{"ch":"Google Ads","camp":"Google_Generic","co":30631.15,"im":2934281,"cl":92219,"cv":2134,"rv":71056.34},{"ch":"Google Ads","camp":"Google_Retargeting","co":10190.23,"im":881423,"cl":54626,"cv":2493,"rv":30893.35},{"ch":"Naver Ads","camp":"Naver_Brand","co":12584.15,"im":1179786,"cl":84291,"cv":5931,"rv":51067.45},{"ch":"Naver Ads","camp":"Naver_Retargeting","co":8438.93,"im":747784,"cl":48770,"cv":2967,"rv":28933.71},{"ch":"Naver Ads","camp":"Naver_Shopping","co":29896.14,"im":2657018,"cl":105484,"cv":3881,"rv":85926.08}];

    // ===== FILTER STATE =====
    let activeChannels = new Set(ALL_CHANNELS);
    let startDate = '2024-10-01';
    let endDate = '2024-12-29';

    // ===== CHART INSTANCES =====
    let barChart, pieChart, lineChart, bubbleChart;

    // ===== HELPERS =====
    function filterData() {
        return rawDaily.filter(d => activeChannels.has(d.c) && d.d >= startDate && d.d <= endDate);
    }

    function compute7dMA(arr) {
        return arr.map((v, i) => {
            const start = Math.max(0, i - 6);
            const slice = arr.slice(start, i + 1);
            return +(slice.reduce((a, b) => a + b, 0) / slice.length).toFixed(2);
        });
    }

    function fmt$(v) { return '$' + Math.round(v).toLocaleString(); }

    // ===== UPDATE ALL =====
    function updateAll() {
        const fd = filterData();
        const channels = [...activeChannels].sort((a, b) => ALL_CHANNELS.indexOf(a) - ALL_CHANNELS.indexOf(b));
        const dates = [...new Set(fd.map(d => d.d))].sort();
        const days = dates.length;

        // Aggregate by channel
        const byChannel = {};
        channels.forEach(ch => { byChannel[ch] = { co:0, im:0, cl:0, cv:0, rv:0 }; });
        fd.forEach(d => {
            const a = byChannel[d.c];
            if (!a) return;
            a.co += d.co; a.im += d.im; a.cl += d.cl; a.cv += d.cv; a.rv += d.rv;
        });

        const totalCost = channels.reduce((s, ch) => s + byChannel[ch].co, 0);
        const totalRev = channels.reduce((s, ch) => s + byChannel[ch].rv, 0);
        const totalConv = channels.reduce((s, ch) => s + byChannel[ch].cv, 0);
        const avgRoas = totalCost > 0 ? (totalRev / totalCost) : 0;

        // KPI Cards
        document.getElementById('kpiSpend').textContent = fmt$(totalCost);
        document.getElementById('kpiRevenue').textContent = fmt$(totalRev);
        document.getElementById('kpiRoas').textContent = avgRoas.toFixed(2);
        document.getElementById('kpiConversions').textContent = totalConv.toLocaleString();

        // Header meta
        document.getElementById('headerPeriod').textContent = '기간: ' + startDate + ' ~ ' + endDate + ' (' + days + '일)';
        document.getElementById('headerChannels').textContent = '채널: ' + channels.map(c => c + ' Ads').join(', ');
        document.getElementById('headerData').textContent = '데이터: ' + (fd.length * 3) + '행 (' + channels.length + '채널 x 3캠페인 x ' + days + '일)';

        // Filter summary
        document.getElementById('filterSummary').textContent =
            channels.length + '개 채널 | ' + days + '일 | ' + fd.length + '개 일별 데이터';

        // 1. ROAS Bar Chart
        const barLabels = channels.map(ch => ch + ' Ads');
        const barData = channels.map(ch => byChannel[ch].co > 0 ? +(byChannel[ch].rv / byChannel[ch].co).toFixed(2) : 0);
        barChart.data.labels = barLabels;
        barChart.data.datasets[0].data = barData;
        barChart.data.datasets[0].backgroundColor = channels.map(ch => COLORS[ch].bg);
        barChart.data.datasets[0].borderColor = channels.map(ch => COLORS[ch].border);
        barChart.options.scales.y.max = Math.max(4, Math.ceil(Math.max(...barData) + 0.5));
        barChart.update();

        // 2. Revenue Pie Chart
        const pieRevs = channels.map(ch => Math.round(byChannel[ch].rv));
        const pieTotalRev = pieRevs.reduce((a, b) => a + b, 0);
        pieChart.data.labels = channels.map((ch, i) => {
            const pct = pieTotalRev > 0 ? (pieRevs[i] / pieTotalRev * 100).toFixed(1) : '0.0';
            return ch + ' Ads (' + pct + '%)';
        });
        pieChart.data.datasets[0].data = pieRevs;
        pieChart.data.datasets[0].backgroundColor = channels.map(ch => COLORS[ch].bg);
        pieChart.options.plugins.tooltip.callbacks.label = function(ctx) {
            var v = ctx.raw;
            var pct = pieTotalRev > 0 ? (v / pieTotalRev * 100).toFixed(1) : '0.0';
            return '$' + v.toLocaleString() + ' (' + pct + '%)';
        };
        pieChart.update();

        // 3. Daily ROAS Line Chart
        var lineDatasets = [];
        channels.forEach(function(ch) {
            var chData = fd.filter(function(d) { return d.c === ch; }).sort(function(a, b) { return a.d.localeCompare(b.d); });
            var dailyRoas = chData.map(function(d) { return d.co > 0 ? +(d.rv / d.co).toFixed(2) : 0; });
            var ma7d = compute7dMA(dailyRoas);
            var col = COLORS[ch];
            lineDatasets.push({
                label: ch + ' 일별', data: dailyRoas,
                borderColor: col.bg, backgroundColor: col.light,
                borderWidth: 1, pointRadius: 0, tension: 0.3, fill: false
            });
            lineDatasets.push({
                label: ch + ' 7일 평균', data: ma7d,
                borderColor: col.bg, backgroundColor: col.bg,
                borderWidth: 2.5, pointRadius: 0, tension: 0.4, fill: false
            });
        });
        lineChart.data.labels = dates.map(function(d) { return d.slice(5); });
        lineChart.data.datasets = lineDatasets;
        lineChart.update();

        // 4. Campaign Bubble Chart
        var filteredCamp = rawCampaign.filter(function(c) { return activeChannels.has(c.ch.replace(' Ads', '')); });
        bubbleChart.data.datasets = filteredCamp.map(function(c) {
            var chKey = c.ch.replace(' Ads', '');
            var col = COLORS[chKey] || COLORS.Google;
            var roas = c.co > 0 ? +(c.rv / c.co).toFixed(2) : 0;
            return {
                label: c.camp,
                data: [{ x: c.co / 1000, y: c.rv / 1000, r: roas * 4 }],
                backgroundColor: col.bg + '99',
                borderColor: col.border,
                borderWidth: 1.5
            };
        });
        bubbleChart.update();

        // 5. Funnel Table
        var tbody = document.getElementById('funnelBody');
        var rows = channels
            .map(function(ch) { return Object.assign({ ch: ch }, byChannel[ch]); })
            .sort(function(a, b) {
                var ra = a.co > 0 ? a.rv / a.co : 0;
                var rb = b.co > 0 ? b.rv / b.co : 0;
                return rb - ra;
            });
        var maxRoas = rows.length > 0 && rows[0].co > 0 ? rows[0].rv / rows[0].co : 0;
        tbody.innerHTML = rows.map(function(r) {
            var ctr = r.im > 0 ? (r.cl / r.im * 100).toFixed(2) : '0.00';
            var cvr = r.cl > 0 ? (r.cv / r.cl * 100).toFixed(2) : '0.00';
            var cpa = r.cv > 0 ? (r.co / r.cv).toFixed(2) : '-';
            var roas = r.co > 0 ? (r.rv / r.co).toFixed(2) : '0.00';
            var roasVal = parseFloat(roas);
            var tag = 'tag-warn', label = '개선 필요';
            if (roasVal >= maxRoas * 0.95) { tag = 'tag-best'; label = '최고'; }
            else if (roasVal >= 2.5) { tag = 'tag-good'; label = '양호'; }
            var color = COLORS[r.ch] ? COLORS[r.ch].bg : '#666';
            return '<tr>' +
                '<td><strong style="color:' + color + '">' + r.ch + ' Ads</strong></td>' +
                '<td class="num">' + ctr + '</td><td class="num">' + cvr + '</td>' +
                '<td class="num">' + cpa + '</td><td class="num"><strong>' + roas + '</strong></td>' +
                '<td><span class="tag ' + tag + '">' + label + '</span></td>' +
            '</tr>';
        }).join('');
    }

    // ===== INIT CHARTS =====
    barChart = new Chart(document.getElementById('roasBarChart').getContext('2d'), {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ROAS', data: [], borderWidth: 2, borderRadius: 6, barPercentage: 0.6 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx) { return 'ROAS: ' + ctx.raw.toFixed(2) + 'x'; } } } },
            scales: {
                y: { beginAtZero: true, max: 4, ticks: { callback: function(v) { return v.toFixed(1) + 'x'; } }, grid: { color: '#f1f3f4' } },
                x: { grid: { display: false } }
            }
        }
    });

    pieChart = new Chart(document.getElementById('revenuePieChart').getContext('2d'), {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], borderColor: '#fff', borderWidth: 3, hoverOffset: 8 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true, pointStyle: 'circle' } },
                tooltip: { callbacks: { label: function(ctx) { return '$' + ctx.raw.toLocaleString(); } } }
            }
        }
    });

    lineChart = new Chart(document.getElementById('roasLineChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { usePointStyle: true, pointStyle: 'line', padding: 12, filter: function(item) { return item.text.includes('7일 평균'); } }
                },
                tooltip: { callbacks: { label: function(ctx) { return ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + 'x'; } } }
            },
            scales: {
                y: { min: 0, max: 7, ticks: { callback: function(v) { return v.toFixed(1) + 'x'; } }, grid: { color: '#f1f3f4' } },
                x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 15 }, grid: { display: false } }
            }
        }
    });

    bubbleChart = new Chart(document.getElementById('campaignBubbleChart').getContext('2d'), {
        type: 'bubble',
        data: { datasets: [] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: {
                    label: function(ctx) {
                        var d = ctx.raw;
                        return [ctx.dataset.label, '비용: $' + (d.x*1000).toLocaleString(), '매출: $' + (d.y*1000).toLocaleString(), 'ROAS: ' + (d.r/4).toFixed(2) + 'x'];
                    }
                } }
            },
            scales: {
                x: { title: { display: true, text: '비용 ($K)', font: { size: 12 } }, grid: { color: '#f1f3f4' } },
                y: { title: { display: true, text: '매출 ($K)', font: { size: 12 } }, grid: { color: '#f1f3f4' } }
            }
        }
    });

    // ===== EVENT LISTENERS =====
    document.querySelectorAll('.ch-toggle').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var ch = btn.dataset.ch;
            if (activeChannels.has(ch)) {
                if (activeChannels.size > 1) {
                    activeChannels.delete(ch);
                    btn.classList.remove('active');
                }
            } else {
                activeChannels.add(ch);
                btn.classList.add('active');
            }
            updateAll();
        });
    });

    document.getElementById('startDate').addEventListener('change', function(e) {
        startDate = e.target.value;
        if (startDate > endDate) { endDate = startDate; document.getElementById('endDate').value = endDate; }
        updateAll();
    });
    document.getElementById('endDate').addEventListener('change', function(e) {
        endDate = e.target.value;
        if (endDate < startDate) { startDate = endDate; document.getElementById('startDate').value = startDate; }
        updateAll();
    });

    function resetFilters() {
        activeChannels = new Set(ALL_CHANNELS);
        startDate = '2024-10-01'; endDate = '2024-12-29';
        document.getElementById('startDate').value = startDate;
        document.getElementById('endDate').value = endDate;
        document.querySelectorAll('.ch-toggle').forEach(function(btn) { btn.classList.add('active'); });
        updateAll();
    }

    // ===== INITIAL RENDER =====
    updateAll();
    </script>
</body>
</html>
